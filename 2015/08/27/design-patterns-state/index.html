
 <!DOCTYPE HTML>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
    <title>设计模式之状态模式(State) | 飛哥の技术博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="李飛">
    

    
    <meta name="description" content="概述


在软件开发过程中，应用程序可能会根据不同的情况作出不同的处理。
最直接的解决方案是将这些所有可能发生的情况全都考虑到。
然后使用if&amp;#8230;&amp;#8203; else语句来做状态判断来进行不同情况的处理。
但是对复杂状态的判断就显得“力不从心了”。
随着增加新的状态或者修改一个状体（if else(或switch case)语句的增多或者修改）可能会引起很大的修改，
而程序的可读性，">
<meta property="og:type" content="article">
<meta property="og:title" content="设计模式之状态模式(State)">
<meta property="og:url" content="http://lifei.github.io/2015/08/27/design-patterns-state/index.html">
<meta property="og:site_name" content="飛哥の技术博客">
<meta property="og:description" content="概述


在软件开发过程中，应用程序可能会根据不同的情况作出不同的处理。
最直接的解决方案是将这些所有可能发生的情况全都考虑到。
然后使用if&amp;#8230;&amp;#8203; else语句来做状态判断来进行不同情况的处理。
但是对复杂状态的判断就显得“力不从心了”。
随着增加新的状态或者修改一个状体（if else(或switch case)语句的增多或者修改）可能会引起很大的修改，
而程序的可读性，">
<meta property="og:updated_time" content="2015-12-20T18:05:02.732Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="设计模式之状态模式(State)">
<meta name="twitter:description" content="概述


在软件开发过程中，应用程序可能会根据不同的情况作出不同的处理。
最直接的解决方案是将这些所有可能发生的情况全都考虑到。
然后使用if&amp;#8230;&amp;#8203; else语句来做状态判断来进行不同情况的处理。
但是对复杂状态的判断就显得“力不从心了”。
随着增加新的状态或者修改一个状体（if else(或switch case)语句的增多或者修改）可能会引起很大的修改，
而程序的可读性，">

    
    <link rel="alternative" href="/atom.xml" title="飛哥の技术博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="飛哥の技术博客" title="飛哥の技术博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="飛哥の技术博客">飛哥の技术博客</a></h1>
				<h2 class="blog-motto">关注业务开发</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:lifei.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/27/design-patterns-state/" title="设计模式之状态模式(State)" itemprop="url">设计模式之状态模式(State)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="李飛" target="_blank" itemprop="author">李飛</a>
		
  <p class="article-time">
    <time datetime="2015-08-27T03:21:15.000Z" itemprop="datePublished"> 發表於 2015-08-27</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#__"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___2"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___3"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___4"><span class="toc-number">4.</span> <span class="toc-text">适用性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___5"><span class="toc-number">5.</span> <span class="toc-text">结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___6"><span class="toc-number">6.</span> <span class="toc-text">模式的组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___7"><span class="toc-number">7.</span> <span class="toc-text">效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___8"><span class="toc-number">8.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___9"><span class="toc-number">9.</span> <span class="toc-text">与其他相关模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#___10"><span class="toc-number">9.1.</span> <span class="toc-text">职责链模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___11"><span class="toc-number">10.</span> <span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___12"><span class="toc-number">11.</span> <span class="toc-text">总结与分析</span></a></li></ol>
		
		</div>
		
		<div class="sect1">
<h2 id="__">概述</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在软件开发过程中，应用程序可能会根据不同的情况作出不同的处理。
最直接的解决方案是将这些所有可能发生的情况全都考虑到。
然后使用<code>if&#8230;&#8203; else</code>语句来做状态判断来进行不同情况的处理。
但是对复杂状态的判断就显得“力不从心了”。
随着增加新的状态或者修改一个状体（if else(或switch case)语句的增多或者修改）可能会引起很大的修改，
而程序的可读性，扩展性也会变得很弱。
维护也会很麻烦。那么我就考虑只修改自身状态的模式。</p>
</div>
<div class="paragraph">
<p>例子1：按钮来控制一个电梯的状态，一个电梯开们，关门，停，运行。
每一种状态改变，都有可能要根据其他状态来更新处理。
例如，开门状体，你不能在运行的时候开门，而是在电梯定下后才能开门。</p>
</div>
<div class="paragraph">
<p>例子2：我们给一部手机打电话，就可能出现这几种情况：用户开机，用户关机，用户欠费停机，用户消户等。
所以当我们拨打这个号码的时候：系统就要判断，该用户是否在开机且不忙状态，又或者是关机，欠费等状态。
但不管是那种状态我们都应给出对应的处理操作。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___2">问题</h2>
<div class="sectionbody">
<div class="paragraph">
<p>对象如何在每一种状态下表现出不同的行为？</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___3">解决方案</h2>
<div class="sectionbody">
<div class="paragraph">
<p>状态模式：允许一个对象在其内部状态改变时改变它的行为。
对象看起来似乎修改了它的类。</p>
</div>
<div class="paragraph">
<p>在很多情况下，一个对象的行为取决于一个或多个动态变化的属性，这样的属性叫做状态，
这样的对象叫做有状态的(stateful)对象，这样的对象状态是从事先定义好的一系列值中取出的。
当一个这样的对象与外部事件产生互动时，其内部状态就会改变，从而使得系统的行为也随之发生变化。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___4">适用性</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在下面的两种情况下均可使用State模式:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>一个对象的行为取决于它的状态, 并且它必须在运行时刻根据状态改变它的行为。</p>
</li>
<li>
<p>代码中包含大量与对象状态有关的条件语句：一个操作中含有庞大的多分支的条件（if else(或switch case)语句，
且这些分支依赖于该对象的状态。这个状态通常用一个或多个枚举常量表示。通常 , 有多个操作包含这一相同的条件结构。
State模式将每一个条件分支放入一个独立的类中。
这使得你可以根据对象自身的情况将对象的状态作为一个对象，这一对象可以不依赖于其他对象而独立变化。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___5">结构</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="___6">模式的组成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>环境类（Context）:  定义客户感兴趣的接口。维护一个ConcreteState子类的实例，这个实例定义当前状态。</p>
</div>
<div class="paragraph">
<p>抽象状态类（State）:  定义一个接口以封装与Context的一个特定状态相关的行为。</p>
</div>
<div class="paragraph">
<p>具体状态类（ConcreteState）:  每一子类实现一个与Context的一个状态相关的行为。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___7">效果</h2>
<div class="sectionbody">
<div class="paragraph">
<p>State模式有下面一些效果:</p>
</div>
<div class="olist arabic">
<div class="title">状态模式的优点：</div>
<ol class="arabic">
<li>
<p>它将与特定状态相关的行为局部化，并且将不同状态的行为分割开来: State模式将所有与一个特定的状态相关的行为都放入一个对象中。
因为所有与状态相关的代码都存在于某一个State子类中, 所以通过定义新的子类可以很容易的增加新的状态和转换。
另一个方法是使用数据值定义内部状态并且让 Context操作来显式地检查这些数据。
但这样将会使整个Context的实现中遍布看起来很相似的条件if else语句或switch case语句。
增加一个新的状态可能需要改变若干个操作, 这就使得维护变得复杂了。
State模式避免了这个问题, 但可能会引入另一个问题, 因为该模式将不同状态的行为分布在多个State子类中。
这就增加了子类的数目，相对于单个类的实现来说不够紧凑。但是如果有许多状态时这样的分布实际上更好一些, 否则需要使用巨大的条件语句。
正如很长的过程一样，巨大的条件语句是不受欢迎的。它们形成一大整块并且使得代码不够清晰，这又使得它们难以修改和扩展。
State模式提供了一个更好的方法来组织与特定状态相关的代码。决定状态转移的逻辑不在单块的if或switch语句中, 而是分布在State子类之间。
将每一个状态转换和动作封装到一个类中，就把着眼点从执行状态提高到整个对象的状态。
这将使代码结构化并使其意图更加清晰。</p>
</li>
<li>
<p>它使得状态转换显式化：当一个对象仅以内部数据值来定义当前状态时，其状态仅表现为对一些变量的赋值，这不够明确。
为不同的状态引入独立的对象使得转换变得更加明确。
而且，State对象可保证Context不会发生内部状态不一致的情况，因为从 Context的角度看，
状态转换是原子的—只需重新绑定一个变量(即Context的State对象变量)，而无需为多个变量赋值。</p>
</li>
<li>
<p>State对象可被共享 如果State对象没有实例变量，即它们表示的状态完全以它们的类型来编码—那么各Context对象可以共享一个State对象。
当状态以这种方式被共享时, 它们必然是没有内部状态, 只有行为的轻量级对象。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">状态模式的缺点:</div>
<ol class="arabic">
<li>
<p>状态模式的使用必然会增加系统类和对象的个数。</p>
</li>
<li>
<p>状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___8">实现</h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们用电梯的例子来说明：</p>
</div>
<div class="paragraph">
<p>简单地实现代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="preprocessor">&lt;?php</span>
<span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ILift</span> </span>&#123;
    <span class="comment">//电梯的四个状态</span>
    <span class="keyword">const</span> OPENING_STATE = <span class="number">1</span>;  <span class="comment">//门敞状态</span>
    <span class="keyword">const</span> CLOSING_STATE = <span class="number">2</span>;  <span class="comment">//门闭状态</span>
    <span class="keyword">const</span> RUNNING_STATE = <span class="number">3</span>;  <span class="comment">//运行状态</span>
    <span class="keyword">const</span> STOPPING_STATE = <span class="number">4</span>; <span class="comment">//停止状态；</span>


    <span class="comment">//设置电梯的状态</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">setState</span><span class="params">(<span class="variable">$state</span>)</span></span>;

    <span class="comment">//首先电梯门开启动作</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span>;

    <span class="comment">//电梯门有开启，那当然也就有关闭了</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>;

    <span class="comment">//电梯要能上能下，跑起来</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span>;

    <span class="comment">//电梯还要能停下来，停不下来那就扯淡了</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span></span>;
&#125;

<span class="comment">/**
 * 电梯的实现类
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">Lift</span> <span class="keyword">extends</span>  <span class="title">ILift</span> </span>&#123;
    <span class="keyword">private</span> <span class="variable">$state</span>;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setState</span><span class="params">(<span class="variable">$state</span>)</span> </span>&#123;
        <span class="variable">$this</span>-&gt;state = <span class="variable">$state</span>;
    &#125;
    <span class="comment">//电梯门关闭</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;
        <span class="comment">//电梯在什么状态下才能关闭</span>
        <span class="keyword">switch</span>(<span class="variable">$this</span>-&gt;state)&#123;
            <span class="keyword">case</span> ILift::OPENING_STATE:  <span class="comment">//如果是则可以关门，同时修改电梯状态</span>
                <span class="variable">$this</span>-&gt;setState(ILift::CLOSING_STATE);
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::CLOSING_STATE:  <span class="comment">//如果电梯就是关门状态，则什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::RUNNING_STATE: <span class="comment">//如果是正在运行，门本来就是关闭的，也说明都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::STOPPING_STATE:  <span class="comment">//如果是停止状态，本也是关闭的，什么也不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
        &#125;
                <span class="keyword">echo</span> <span class="string">'Lift colse &lt;br&gt;'</span>;
    &#125;

    <span class="comment">//电梯门开启</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span> </span>&#123;
        <span class="comment">//电梯在什么状态才能开启</span>
        <span class="keyword">switch</span>(<span class="variable">$this</span>-&gt;state)&#123;
            <span class="keyword">case</span> ILift::OPENING_STATE: <span class="comment">//如果已经在门敞状态，则什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::CLOSING_STATE: <span class="comment">//如是电梯时关闭状态，则可以开启</span>
                <span class="variable">$this</span>-&gt;setState(ILift::OPENING_STATE);
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::RUNNING_STATE: <span class="comment">//正在运行状态，则不能开门，什么都不做</span>
            <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::STOPPING_STATE: <span class="comment">//停止状态，淡然要开门了</span>
                <span class="variable">$this</span>-&gt;setState(ILift::OPENING_STATE);
            <span class="keyword">break</span>;
        &#125;
        <span class="keyword">echo</span> <span class="string">'Lift open &lt;br&gt;'</span>;
    &#125;
    <span class="comment">///电梯开始跑起来</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;
        <span class="keyword">switch</span>(<span class="variable">$this</span>-&gt;state)&#123;
            <span class="keyword">case</span> ILift::OPENING_STATE: <span class="comment">//如果已经在门敞状态，则不你能运行，什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::CLOSING_STATE: <span class="comment">//如是电梯时关闭状态，则可以运行</span>
                <span class="variable">$this</span>-&gt;setState(ILift::RUNNING_STATE);
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::RUNNING_STATE: <span class="comment">//正在运行状态，则什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::STOPPING_STATE: <span class="comment">//停止状态，可以运行</span>
                <span class="variable">$this</span>-&gt;setState(ILift::RUNNING_STATE);
        &#125;
        <span class="keyword">echo</span> <span class="string">'Lift run &lt;br&gt;'</span>;
    &#125;

    <span class="comment">//电梯停止</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;
        <span class="keyword">switch</span>(<span class="variable">$this</span>-&gt;state)&#123;
            <span class="keyword">case</span> ILift::OPENING_STATE: <span class="comment">//如果已经在门敞状态，那肯定要先停下来的，什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::CLOSING_STATE: <span class="comment">//如是电梯时关闭状态，则当然可以停止了</span>
                <span class="variable">$this</span>-&gt;setState(ILift::CLOSING_STATE);
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::RUNNING_STATE: <span class="comment">//正在运行状态，有运行当然那也就有停止了</span>
                <span class="variable">$this</span>-&gt;setState(ILift::CLOSING_STATE);
            <span class="keyword">break</span>;
            <span class="keyword">case</span> ILift::STOPPING_STATE: <span class="comment">//停止状态，什么都不做</span>
                <span class="comment">//do nothing;</span>
                <span class="keyword">return</span> ;
            <span class="keyword">break</span>;
        &#125;
        <span class="keyword">echo</span> <span class="string">'Lift stop &lt;br&gt;'</span>;
    &#125;

&#125;
<span class="variable">$lift</span> = <span class="keyword">new</span> Lift();

<span class="comment">//电梯的初始条件应该是停止状态</span>
<span class="variable">$lift</span>-&gt;setState(ILift::STOPPING_STATE);
<span class="comment">//首先是电梯门开启，人进去</span>
<span class="variable">$lift</span>-&gt;open();

<span class="comment">//然后电梯门关闭</span>
<span class="variable">$lift</span>-&gt;close();

<span class="comment">//再然后，电梯跑起来，向上或者向下</span>
<span class="variable">$lift</span>-&gt;run();
 <span class="comment">//最后到达目的地，电梯挺下来</span>
<span class="variable">$lift</span>-&gt;stop();
显然我们已经完成了我们的基本业务操作，但是，我们在程序中使用了大量的<span class="keyword">switch</span>…<span class="keyword">case</span>这样的判断（<span class="keyword">if</span>…<span class="keyword">else</span>也是一样),首先是程序的可阅读性很差，其次扩展非常不方便。一旦我们有新的状态加入的话，例如新加通电和断点状态。我们势必要在每个业务方法里边增加相应的<span class="keyword">case</span>语句。也就是四个函数open，close，run，stop都需要修改相应<span class="keyword">case</span>语句。

状态模式：把不同状态的操作分散到不同的状态对象里去完成。看看状态类的uml类图：



代码实现：


<span class="preprocessor">&lt;?php</span>
<span class="comment">/**
 *
 * 定义一个电梯的接口
 */</span>
<span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LiftState</span></span>&#123;

    <span class="comment">//定义一个环境角色，也就是封装状态的变换引起的功能变化</span>
    <span class="keyword">protected</span>  <span class="variable">$_context</span>;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setContext</span><span class="params">(Context <span class="variable">$context</span>)</span></span>&#123;
        <span class="variable">$this</span>-&gt;_context = <span class="variable">$context</span>;
    &#125;

    <span class="comment">//首先电梯门开启动作</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span>;

    <span class="comment">//电梯门有开启，那当然也就有关闭了</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>;

    <span class="comment">//电梯要能上能下，跑起来</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span>;

    <span class="comment">//电梯还要能停下来，停不下来那就扯淡了</span>
    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span></span>;

&#125;


<span class="comment">/**
 * 环境类:定义客户感兴趣的接口。维护一个ConcreteState子类的实例，这个实例定义当前状态。
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;
    <span class="comment">//定义出所有的电梯状态</span>
    <span class="keyword">static</span>  <span class="variable">$openningState</span> = <span class="keyword">null</span>;
    <span class="keyword">static</span>  <span class="variable">$closeingState</span> = <span class="keyword">null</span>;
    <span class="keyword">static</span>  <span class="variable">$runningState</span>  = <span class="keyword">null</span>;
    <span class="keyword">static</span>  <span class="variable">$stoppingState</span> = <span class="keyword">null</span>;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;
        <span class="keyword">self</span>::<span class="variable">$openningState</span> = <span class="keyword">new</span> OpenningState();
        <span class="keyword">self</span>::<span class="variable">$closeingState</span> = <span class="keyword">new</span> ClosingState();
        <span class="keyword">self</span>::<span class="variable">$runningState</span> =  <span class="keyword">new</span> RunningState();
        <span class="keyword">self</span>::<span class="variable">$stoppingState</span> = <span class="keyword">new</span> StoppingState();

    &#125;

    <span class="comment">//定一个当前电梯状态</span>
    <span class="keyword">private</span>  <span class="variable">$_liftState</span>;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLiftState</span><span class="params">()</span> </span>&#123;
        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;_liftState;
    &#125;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setLiftState</span><span class="params">(<span class="variable">$liftState</span>)</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_liftState = <span class="variable">$liftState</span>;
        <span class="comment">//把当前的环境通知到各个实现类中</span>
        <span class="variable">$this</span>-&gt;_liftState-&gt;setContext(<span class="variable">$this</span>);
    &#125;


    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span>&#123;
        <span class="variable">$this</span>-&gt;_liftState-&gt;open();
    &#125;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>&#123;
        <span class="variable">$this</span>-&gt;_liftState-&gt;close();
    &#125;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span>&#123;
        <span class="variable">$this</span>-&gt;_liftState-&gt;run();
    &#125;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span></span>&#123;
        <span class="variable">$this</span>-&gt;_liftState-&gt;stop();
    &#125;
&#125;

<span class="comment">/**
 * 在电梯门开启的状态下能做什么事情
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">OpenningState</span> <span class="keyword">extends</span> <span class="title">LiftState</span> </span>&#123;

    <span class="comment">/**
     * 开启当然可以关闭了，我就想测试一下电梯门开关功能
     *
     */</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;
        <span class="comment">//状态修改</span>
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$closeingState</span>);
        <span class="comment">//动作委托为CloseState来执行</span>
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;close();
    &#125;

    <span class="comment">//打开电梯门</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span> </span>&#123;
        <span class="keyword">echo</span> <span class="string">'lift open...'</span>, <span class="string">'&lt;br/&gt;'</span>;
    &#125;
    <span class="comment">//门开着电梯就想跑，这电梯，吓死你！</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;
        <span class="comment">//do nothing;</span>
    &#125;

    <span class="comment">//开门还不停止？</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;
        <span class="comment">//do nothing;</span>
    &#125;

&#125;

<span class="comment">/**
 * 电梯门关闭以后，电梯可以做哪些事情
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">ClosingState</span> <span class="keyword">extends</span> <span class="title">LiftState</span> </span>&#123;

    <span class="comment">//电梯门关闭，这是关闭状态要实现的动作</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;
        <span class="keyword">echo</span> <span class="string">'lift close...'</span>, <span class="string">'&lt;br/&gt;'</span>;

    &#125;
    <span class="comment">//电梯门关了再打开，逗你玩呢，那这个允许呀</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$openningState</span>);  <span class="comment">//置为门敞状态</span>
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;open();
    &#125;

    <span class="comment">//电梯门关了就跑，这是再正常不过了</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$runningState</span>); <span class="comment">//设置为运行状态；</span>
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;run();
    &#125;

    <span class="comment">//电梯门关着，我就不按楼层</span>

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$stoppingState</span>);  <span class="comment">//设置为停止状态；</span>
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;stop();
    &#125;

&#125;

<span class="comment">/**
 * 电梯在运行状态下能做哪些动作
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">RunningState</span> <span class="keyword">extends</span> <span class="title">LiftState</span> </span>&#123;

    <span class="comment">//电梯门关闭？这是肯定了</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;
        <span class="comment">//do nothing</span>
    &#125;

    <span class="comment">//运行的时候开电梯门？你疯了！电梯不会给你开的</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span> </span>&#123;
        <span class="comment">//do nothing</span>
    &#125;

    <span class="comment">//这是在运行状态下要实现的方法</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;
        <span class="keyword">echo</span> <span class="string">'lift run...'</span>, <span class="string">'&lt;br/&gt;'</span>;
    &#125;

    <span class="comment">//这个事绝对是合理的，光运行不停止还有谁敢做这个电梯？！估计只有上帝了</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$stoppingState</span>); <span class="comment">//环境设置为停止状态；</span>
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;stop();
    &#125;

&#125;



<span class="comment">/**
 * 在停止状态下能做什么事情
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">StoppingState</span> <span class="keyword">extends</span> <span class="title">LiftState</span> </span>&#123;

    <span class="comment">//停止状态关门？电梯门本来就是关着的！</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;
        <span class="comment">//do nothing;</span>
    &#125;

    <span class="comment">//停止状态，开门，那是要的！</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$openningState</span>);
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;open();
    &#125;
    <span class="comment">//停止状态再跑起来，正常的很</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;
        <span class="variable">$this</span>-&gt;_context-&gt;setLiftState(Context::<span class="variable">$runningState</span>);
        <span class="variable">$this</span>-&gt;_context-&gt;getLiftState()-&gt;run();
    &#125;
    <span class="comment">//停止状态是怎么发生的呢？当然是停止方法执行了</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;
        <span class="keyword">echo</span> <span class="string">'lift stop...'</span>, <span class="string">'&lt;br/&gt;'</span>;
    &#125;

&#125;

<span class="comment">/**
 * 模拟电梯的动作
 */</span>
<span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span> </span>&#123;
        <span class="variable">$context</span> = <span class="keyword">new</span> Context();
        <span class="variable">$context</span>-&gt;setLiftState(<span class="keyword">new</span> ClosingState());

        <span class="variable">$context</span>-&gt;open();
        <span class="variable">$context</span>-&gt;close();
        <span class="variable">$context</span>-&gt;run();
        <span class="variable">$context</span>-&gt;stop();
    &#125;
&#125;
Client::main();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___9">与其他相关模式</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="___10">职责链模式</h3>
<div class="paragraph">
<p>职责链模式和状态模式都可以解决if分支语句过多问题。</p>
</div>
<div class="paragraph">
<p>从定义来看，状态模式是一个对象的内在状态发生改变（一个对象，相对比较稳定，处理完一个对象下一个对象的处理一般都已确定），
而职责链模式是多个对象之间的改变（多个对象之间的话，就会出现某个对象不存在的现在，就像我们举例的公司请假流程，经理可能不在公司情况），
这也说明他们两个模式处理的情况不同。</p>
</div>
<div class="paragraph">
<p>这两个设计模式最大的区别就是状态模式是让各个状态对象自己知道其下一个处理的对象是谁。
而职责链模式中的各个对象并不指定其下一个处理的对象到底是谁，只有在客户端才设定。</p>
</div>
<div class="paragraph">
<p>用我们通俗的编程语言来说，就是</p>
</div>
<div class="ulist">
<div class="title">状态模式：</div>
<ul>
<li>
<p>相当于<code>if &#8230;&#8203; else if &#8230;&#8203; else</code>；</p>
</li>
<li>
<p>设计路线：各个State类的内部实现(相当于if &#8230;&#8203; else if &#8230;&#8203; 内的条件)</p>
</li>
<li>
<p>执行时通过State调用Context方法来执行。</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">职责链模式：</div>
<ul>
<li>
<p>相当于<code>swich &#8230;&#8203; case</code></p>
</li>
<li>
<p>设计路线：客户设定，每个子类(case)的参数是下一个子类(case)。</p>
</li>
<li>
<p>使用时，向链的第一个子类的执行方法传递参数就可以。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___11">策略模式</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>状态模式是策略模式的孪生兄弟</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>状态模式和策略模式的实现方法非常类似，都是利用多态把一些操作分配到一组相关的简单的类中，因此很多人认为这两种模式实际上是相同的。
然而在现实世界中，策略（如促销一种商品的策略）和状态（如同一个按钮来控制一个电梯的状态，又如手机界面中一个按钮来控制手机）是两种完全不同的思想。
当我们对状态和策略进行建模时，这种差异会导致完全不同的问题。例如，对状态进行建模时，状态迁移是一个核心内容；
然而，在选择策略时，迁移与此毫无关系。另外，策略模式允许一个客户选择或提供一种策略，而这种思想在状态模式中完全没有。</p>
</div>
<div class="paragraph">
<p>一个策略是一个计划或方案，通过执行这个计划或方案，我们可以在给定的输入条件下达到一个特定的目标。</p>
</div>
<div class="paragraph">
<p>策略是一组方案，他们可以相互替换；选择一个策略，获得策略的输出。策略模式用于随不同外部环境采取不同行为的场合。
我们可以参考微软企业库底层Object Builder的创建对象的Strategy实现方式。</p>
</div>
<div class="paragraph">
<p>而状态模式不同，对一个状态特别重要的对象，通过状态机来建模一个对象的状态；
状态模式处理的核心问题是状态的迁移，因为在对象存在很多状态情况下，对各个Business flow，各个状态之间跳转和迁移过程都是及其复杂的。</p>
</div>
<div class="paragraph">
<p>例如一个工作流，审批一个文件，存在新建、提交、已修改、HR部门审批中、老板审批中、HR审批失败、老板审批失败等状态，涉及多个角色交互，涉及很多事件，这种情况下用状态模式(状态机)来建模更加合适；把各个状态和相应的实现步骤封装成一组简单的继承自一个接口或抽象类的类，通过另外的一个Context来操作他们之间的自动状态变换，通过event来自动实现各个状态之间的跳转。在整个生命周期中存在一个状态的迁移曲线，这个迁移曲线对客户是透明的。我们可以参考微软最新的WWF 状态机工作流实现思想。</p>
</div>
<div class="paragraph">
<p>在状态模式中，状态的变迁是由对象的内部条件决定，外界只需关心其接口，不必关心其状态对象的创建和转化，而策略模式里，采取何种策略由外部条件( C)决定。</p>
</div>
<div class="paragraph">
<p>他们应用场景（目的）却不一样，State模式重在强调对象内部状态的变化改变对象的行为，Strategy模式重在外部对策略的选择，策略的选择由外部条件决定，
也就是说算法的动态的切换。但由于它们的结构是如此的相似，我们可以认为“状态模式是完全封装且自修改的策略模式”。即状态模式是封装对象内部的状态的，而策略模式是封装算法族的</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___12">总结与分析</h2>
<div class="sectionbody">
<div class="paragraph">
<p>状态模式的主要优点在于封装了转换规则，并枚举可能的状态，它将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为，还可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数；其缺点在于使用状态模式会增加系统类和对象的个数，且状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱，对于可以切换状态的状态模式不满足“开闭原则”的要求。</p>
</div>
</div>
</div>  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://lifei.github.io/2015/08/27/design-patterns-state/" data-title="设计模式之状态模式(State) | 飛哥の技术博客" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/27/programming-proverbs/" title="每个程序员都应该熟知的编程格言">
  <strong>上一篇：</strong><br/>
  <span>
  每个程序员都应该熟知的编程格言</span>
</a>
</div>


<div class="next">
<a href="/2015/08/26/oo/"  title="面向对象的设计原则">
 <strong>下一篇：</strong><br/> 
 <span>面向对象的设计原则
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/08/27/design-patterns-state/" data-title="设计模式之状态模式(State)" data-url="http://lifei.github.io/2015/08/27/design-patterns-state/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#__"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___2"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___3"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___4"><span class="toc-number">4.</span> <span class="toc-text">适用性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___5"><span class="toc-number">5.</span> <span class="toc-text">结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___6"><span class="toc-number">6.</span> <span class="toc-text">模式的组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___7"><span class="toc-number">7.</span> <span class="toc-text">效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___8"><span class="toc-number">8.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___9"><span class="toc-number">9.</span> <span class="toc-text">与其他相关模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#___10"><span class="toc-number">9.1.</span> <span class="toc-text">职责链模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___11"><span class="toc-number">10.</span> <span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#___12"><span class="toc-number">11.</span> <span class="toc-text">总结与分析</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/工具/开山利器/" title="开山利器">开山利器<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/单体应用/" title="单体应用">单体应用<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/微服务/" title="微服务">微服务<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/领域实体/" title="领域实体">领域实体<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/API/" title="API">API<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/OpenVPN/" title="OpenVPN">OpenVPN<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Kerberos/" title="Kerberos">Kerberos<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SSH/" title="SSH">SSH<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/运维/" title="运维">运维<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Webpack/" title="Webpack">Webpack<sup>1</sup></a></li>
			
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">歸檔</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">11</span></li></ul>
  </div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">標簽雲</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/Kerberos/" style="font-size: 10px;">Kerberos</a> <a href="/tags/OpenVPN/" style="font-size: 10px;">OpenVPN</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/单体应用/" style="font-size: 10px;">单体应用</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a> <a href="/tags/领域实体/" style="font-size: 10px;">领域实体</a>
    </div>
  </div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 大家好，我是李飛。 <br/>
			这是我的博客。</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/https://github.com/lifei" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:lifei.vip@outlook.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nc-nd/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nc-nd.svg" alt="Creative Commons" />
          </a>
        </div>
    

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="李飛">李飛</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"lifei"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
