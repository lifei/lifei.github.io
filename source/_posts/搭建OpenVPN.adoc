title: 搭建OpenVPN
date: 2015-10-03 02:05:16
tags:
---

== 部署OpenVPN

以`vpn.7v1.net`为例，参考地址`https://hub.docker.com/r/kylemanna/openvpn/`。

[source, bash]
----
docker run --rm -it --hostname=vpn.7v1.net -p 1194:1194/udp --cap-add=NET_ADMIN lifei/openvpn /sbin/my_init -- bash

# 初始化配置文件
ovpn_genconfig -u udp://vpn.7v1.net:1194
# 初始化pki
ovpn_initpki
# 生成request
easyrsa build-client-full CLIENTNAME nopass
# 该request的ovpn
ovpn_getclient CLIENTNAME > CLIENTNAME.ovpn
----

# 服务器配置文件摘录

[source, conf]
----

# key和ca
key /etc/openvpn/pki/private/server.rsphost.com.key
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/issued/server.rsphost.com.crt
dh /etc/openvpn/pki/dh.pem

# tls认证
tls-auth /etc/openvpn/pki/ta.key
key-direction 0

keepalive 10 60

persist-key
persist-tun

verb 3

proto tcp
port 1194
dev tun0
status /var/log/openvpn-status.log

user nobody
group nogroup

# 为每个用户分配相同的虚拟IP
ifconfig-pool-persist ipp.txt

# 客户端直接可见
client-to-client

# VPN的虚拟网段
server 10.8.0.0 255.255.0.0

# 向客户端推送网段的配置信息
# Gateway参数很重要，否则ping不通
push "route 10.8.0.0 255.255.255.0 10.8.0.1"


# 向客户端推送另外一个网段
route 172.17.42.0 255.255.255.0
push "route 172.17.42.0 255.255.255.0"

# 向客户端推送DNS
push dhcp-option DNS 172.17.42.1

# 开启压缩，客户端配置文件中也需要开启
comp-lzo
----

== 设置授权

修复服务器配置文件，增加`auth-user-pass-verify`，细节可参考`man openvpn`。

----
auth-user-pass-verify /etc/openvpn/check-user.sh via-env
----

client的配置文件增加`auth-user-pass`一项。
